<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Animado con Leaflet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        /* TODO: Incluye los estilos CSS que ya compartiste aquí */
    </style>
</head>
<body>
    <!-- TODO: Controles, panel de información y mapa como ya están definidos -->

    <script>
        // Continuación del código JavaScript para completar la funcionalidad del mapa animado

        // Actualizar panel de información
        function updateInfoPanel(index) {
            const point = movementData[index];
            document.getElementById('current-location').innerHTML = `<strong>Ubicación:</strong> ${point.description}`;
            document.getElementById('current-coords').innerHTML = `<strong>Coordenadas:</strong> ${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}`;
            document.getElementById('current-time').innerHTML = `<strong>Tiempo:</strong> ${new Date(point.timestamp).toLocaleString('es-CL')}`;
            document.getElementById('progress').innerHTML = `<strong>Progreso:</strong> ${((index / (movementData.length - 1)) * 100).toFixed(1)}%`;
            document.getElementById('speed-info').innerHTML = `<strong>Velocidad:</strong> ${speed}x`;
        }

        // Calcular distancia total
        function updateDistanceInfo() {
            let total = 0;
            for (let i = 1; i < movementData.length; i++) {
                const a = movementData[i - 1];
                const b = movementData[i];
                total += calculateDistance(a.lat, a.lng, b.lat, b.lng);
            }
            document.getElementById('distance-info').innerHTML = `<strong>Distancia:</strong> ${total.toFixed(2)} km`;
        }

        function moveNext() {
            if (currentIndex >= movementData.length - 1) {
                clearInterval(animationInterval);
                isPlaying = false;
                document.getElementById('play-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                return;
            }

            currentIndex++;
            const point = movementData[currentIndex];
            personMarker.setLatLng([point.lat, point.lng]);
            map.panTo([point.lat, point.lng]);
            visitedMarkers[currentIndex].setOpacity(1);
            updateInfoPanel(currentIndex);
        }

        function playAnimation() {
            if (isPlaying) return;
            isPlaying = true;
            document.getElementById('play-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;

            animationInterval = setInterval(moveNext, 1000 / speed);
        }

        function pauseAnimation() {
            isPlaying = false;
            clearInterval(animationInterval);
            document.getElementById('play-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
        }

        function resetAnimation() {
            pauseAnimation();
            currentIndex = 0;
            personMarker.setLatLng([movementData[0].lat, movementData[0].lng]);
            visitedMarkers.forEach((marker, idx) => marker.setOpacity(idx === 0 ? 1 : 0));
            map.panTo([movementData[0].lat, movementData[0].lng]);
            updateInfoPanel(0);
        }

        // Cambiar velocidad
        document.getElementById('speed-select').addEventListener('change', (e) => {
            speed = parseFloat(e.target.value);
            if (isPlaying) {
                clearInterval(animationInterval);
                animationInterval = setInterval(moveNext, 1000 / speed);
            }
            updateInfoPanel(currentIndex);
        });

        // Mostrar trayectoria
        document.getElementById('show-path').addEventListener('change', (e) => {
            pathPolyline.setStyle({ opacity: e.target.checked ? 0.8 : 0 });
        });

        // Mostrar puntos visitados
        document.getElementById('show-visited').addEventListener('change', (e) => {
            visitedMarkers.forEach(marker => marker.setOpacity(e.target.checked ? 1 : 0));
        });

        // Cambiar estilo de mapa
        document.getElementById('map-style').addEventListener('change', (e) => {
            const newStyle = e.target.value;
            map.removeLayer(mapLayers[currentTileLayer]);
            currentTileLayer = newStyle;
            map.addLayer(mapLayers[currentTileLayer]);
        });

        // Botones
        document.getElementById('play-btn').addEventListener('click', playAnimation);
        document.getElementById('pause-btn').addEventListener('click', pauseAnimation);
        document.getElementById('reset-btn').addEventListener('click', resetAnimation);
        document.getElementById('fit-btn').addEventListener('click', () => {
            const bounds = L.latLngBounds(movementData.map(p => [p.lat, p.lng]));
            map.fitBounds(bounds, { padding: [20, 20] });
        });

        // Inicialización
        initializeMap();
        updateInfoPanel(0);
        updateDistanceInfo();
    </script>
</body>
</html>
